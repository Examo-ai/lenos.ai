<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lenos.ai</title>
    <!-- KaTeX für LaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1tBCETigGWipszzSo+AUXLy2eVvx" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmImKTgiLR" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44SUqw4MB1trInXZnVdkYWPIx7vZ199QCsmSaxCVA" crossorigin="anonymous"></script>
    <!-- Google Fonts (Poppins) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-interactive: #303030;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --text-placeholder: #888888;
            --accent-color: #0ea5e9; /* Sky Blue */
            --accent-hover: #0284c7;
            --accent-glow: rgba(14, 165, 233, 0.3);
            --error-color: #f43f5e;
            --error-bg: rgba(244, 63, 94, 0.1);
            --user-bubble: linear-gradient(135deg, #059669, #047857);
            --user-text: #ffffff;
            --ai-bubble: var(--bg-tertiary);
            --ai-text: var(--text-primary);
            --thought-bubble: #1f1f1f;
            --thought-text: var(--text-secondary);
            --border-color: #383838;
            --font-main: 'Poppins', sans-serif;
            --border-radius-main: 16px;
            --border-radius-medium: 12px;
            --border-radius-small: 8px;
            --padding-main: 24px;
            --padding-medium: 16px;
            --padding-small: 12px;
            --sidebar-width: 280px;
            --header-height: 65px;
            --input-padding-bottom: 24px;
            --transition-speed: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; scrollbar-width: thin; scrollbar-color: var(--bg-interactive) var(--bg-secondary); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background-color: var(--bg-interactive); border-radius: 4px; border: 2px solid var(--bg-secondary); }
        ::-webkit-scrollbar-thumb:hover { background-color: #444; }

        html, body { height: 100%; font-family: var(--font-main); background-color: var(--bg-primary); color: var(--text-primary); overflow: hidden; font-size: 16px; line-height: 1.6; }

        .app-container { display: flex; height: 100vh; }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width); background: linear-gradient(180deg, var(--bg-secondary) 0%, #151515 100%);
            padding: var(--padding-medium); display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color); flex-shrink: 0;
            transition: transform var(--transition-speed); position: fixed;
            left: 0; top: 0; height: 100%; z-index: 100;
            transform: translateX(0); /* Standard: sichtbar (Desktop) */
        }
        .sidebar.collapsed { /* Zustand für mobile Ansicht (versteckt) */
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; min-height: 45px; padding: 0 var(--padding-small); }
        .sidebar-header h1 { font-size: 1.5em; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; }
        .sidebar-header h1 .ai-name { color: var(--accent-color); }
        .sidebar-internal-toggle { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; display: none; /* Nur mobil relevant */ transition: color var(--transition-speed); }
        .sidebar-internal-toggle svg { width: 24px; height: 24px; display: block; }
        .sidebar-internal-toggle:hover { color: var(--text-primary); }

        #new-chat-btn { display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: var(--padding-small) var(--padding-medium); background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius-medium); cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all var(--transition-speed); margin-top: 10px; white-space: nowrap; overflow: hidden; }
        #new-chat-btn svg { margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0;}
        #new-chat-btn:hover { background-color: var(--bg-interactive); color: var(--text-primary); border-color: var(--accent-color); }

        #chat-list { list-style: none; flex-grow: 1; overflow-y: auto; margin-top: var(--padding-medium); padding-right: 5px; }
        #chat-list li { display: flex; align-items: center; justify-content: space-between; padding: var(--padding-small) var(--padding-medium); margin-bottom: 8px; border-radius: var(--border-radius-medium); cursor: pointer; transition: background-color var(--transition-speed), color var(--transition-speed); white-space: nowrap; overflow: hidden; position: relative; color: var(--text-secondary); }
        #chat-list li .chat-name { text-overflow: ellipsis; overflow: hidden; flex-grow: 1; margin-right: 10px;}
        #chat-list li:hover { background-color: var(--bg-interactive); color: var(--text-primary); }
        #chat-list li.active { background-color: var(--accent-color); color: white; font-weight: 500; }
        #chat-list li .delete-chat-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.3em; line-height: 1; cursor: pointer; padding: 0 5px; opacity: 0; transition: opacity var(--transition-speed), color var(--transition-speed); margin-left: auto; flex-shrink: 0; }
        #chat-list li:hover .delete-chat-btn { opacity: 0.7; }
        #chat-list li .delete-chat-btn:hover { opacity: 1; color: var(--error-color); }
        #chat-list li.active .delete-chat-btn { color: white; }

        /* --- Chat Area --- */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--bg-primary); height: 100%; margin-left: var(--sidebar-width); /* Desktop Standard */ transition: margin-left var(--transition-speed); position: relative; }
        .chat-area.sidebar-collapsed { margin-left: 0; } /* Mobile Ansicht */

        .chat-header { height: var(--header-height); padding: 0 var(--padding-main); border-bottom: 1px solid var(--border-color); background-color: rgba(15, 15, 15, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); display: flex; align-items: center; font-weight: 600; font-size: 1.15em; color: var(--text-primary); position: sticky; top: 0; z-index: 10; flex-shrink: 0; }
        #sidebar-toggle-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 10px; margin-right: var(--padding-medium); display: none; /* Standard unsichtbar */ transition: color var(--transition-speed); }
        #sidebar-toggle-btn svg { width: 24px; height: 24px; display: block; }
        #sidebar-toggle-btn:hover { color: var(--text-primary); }
        #current-chat-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Willkommensnachricht */
        .welcome-message { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary); font-size: 1.2em; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease; pointer-events: none; }
        .welcome-message.visible { opacity: 1; visibility: visible; }
        .welcome-message .logo { font-size: 2.5em; font-weight: 600; margin-bottom: 15px; }
        .welcome-message .logo .ai-name { color: var(--accent-color); }

        .chat-messages { flex-grow: 1; overflow-y: auto; padding: var(--padding-main); display: flex; flex-direction: column; gap: var(--padding-medium); }
        .message { display: flex; max-width: 85%; position: relative; }
        .message-bubble { padding: var(--padding-small) var(--padding-medium); border-radius: var(--border-radius-medium); word-wrap: break-word; box-shadow: var(--shadow-sm); position: relative; }
        .message .sender { font-size: 0.85em; font-weight: 600; margin-bottom: 6px; display: block; opacity: 0.9; }
        .message-content { line-height: 1.65; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--bg-interactive); margin-right: 12px; flex-shrink: 0; align-self: flex-start; font-size: 0.8em; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text-primary); box-shadow: var(--shadow-sm); }
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .user-message .message-avatar { background: var(--user-bubble); color: var(--user-text); margin-right: 0; margin-left: 12px; }
        .user-message .message-bubble { background: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: var(--border-radius-small); }
        .user-message .sender { display: none; }
        .ai-message { align-self: flex-start; }
        .ai-message .message-avatar { background-color: var(--accent-color); }
        .ai-message .message-bubble { background-color: var(--ai-bubble); color: var(--ai-text); border-bottom-left-radius: var(--border-radius-small); }
        .ai-message .sender { color: var(--accent-color); }
        .system-thought-message { align-self: center; max-width: 90%; opacity: 0.8; font-size: 0.9em; }
        .system-thought-message .message-avatar { background-color: var(--thought-bubble); color: var(--text-secondary); font-size: 0.6em; width: 30px; height: 30px;}
        .system-thought-message .message-bubble { background-color: var(--thought-bubble); color: var(--thought-text); font-style: italic; border-radius: var(--border-radius-small); padding: 8px 12px; box-shadow: none; }
        .system-thought-message .sender { color: var(--text-secondary); font-weight: 500; }
        .error-message { align-self: center; max-width: 90%; }
        .error-message .message-avatar { background-color: var(--error-bg); color: var(--error-color); font-size: 1em; }
        .error-message .message-bubble { background-color: var(--error-bg); color: var(--error-color); border: 1px solid var(--error-color); border-radius: var(--border-radius-medium); box-shadow: none;}
        .error-message .sender { color: var(--error-color); font-weight: 600; }

        /* Markdown & KaTeX Styling */
        .message-bubble pre { background-color: rgba(0,0,0,0.3); padding: var(--padding-small); border-radius: var(--border-radius-small); overflow-x: auto; margin: 10px 0; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; border: 1px solid var(--border-color); }
        .message-bubble code:not(pre code) { background-color: rgba(255,255,255,0.1); padding: 3px 6px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; }
        .message-bubble strong { font-weight: 600; }
        .message-bubble em { font-style: italic; color: #c7d2fe; }
        .message-bubble ul, .message-bubble ol { margin: 10px 0 10px 25px; padding-left: 15px;}
        .message-bubble li { margin-bottom: 6px; }
        .message-bubble blockquote { border-left: 4px solid var(--accent-color); padding-left: var(--padding-medium); margin: 12px 0; color: var(--text-secondary); font-style: italic; background-color: rgba(14, 165, 233, 0.05); border-radius: 0 var(--border-radius-small) var(--border-radius-small) 0; }
        .message-bubble a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        .message-bubble a:hover { text-decoration: underline; }
        .katex { font-size: 1.1em; }

        /* --- Input Area --- */
        .input-area { padding: var(--padding-medium) var(--padding-main) var(--input-padding-bottom); border-top: 1px solid var(--border-color); background: linear-gradient(180deg, rgba(15, 15, 15, 0), var(--bg-primary) 60%); position: sticky; bottom: 0; z-index: 5; flex-shrink: 0; display: flex; flex-direction: column; gap: var(--padding-medium); transition: opacity 0.3s, visibility 0.3s; }
        .input-area.hidden { opacity: 0; visibility: hidden; pointer-events: none; /* Vollständig ausblenden */ }

        .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .action-buttons button { padding: 8px 16px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-secondary); border-radius: var(--border-radius-medium); cursor: pointer; transition: all var(--transition-speed); font-size: 0.9em; font-weight: 500; }
        .action-buttons button:hover { background-color: var(--bg-interactive); color: var(--text-primary); border-color: var(--text-secondary); }
        .action-buttons button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }

        .input-wrapper { display: flex; gap: 10px; align-items: flex-end; background-color: var(--bg-secondary); border-radius: var(--border-radius-main); padding: 10px 12px 10px 16px; border: 1px solid var(--border-color); transition: border-color var(--transition-speed), box-shadow var(--transition-speed); box-shadow: var(--shadow-md); }
        .input-wrapper:focus-within { border-color: var(--accent-color); box-shadow: 0 0 8px var(--accent-glow), var(--shadow-md); }
        #message-input { flex-grow: 1; border: none; background-color: transparent; color: var(--text-primary); font-family: var(--font-main); font-size: 1.05em; resize: none; min-height: 26px; max-height: 250px; overflow-y: auto; line-height: 1.6; outline: none; padding: 6px 0; }
        #message-input::placeholder { color: var(--text-placeholder); }
        #send-button { background-color: var(--accent-color); color: white; border: none; border-radius: var(--border-radius-medium); width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all var(--transition-speed); align-self: flex-end; }
        #send-button:hover { background-color: var(--accent-hover); transform: scale(1.05); }
        #send-button:disabled { background-color: var(--bg-interactive); cursor: not-allowed; opacity: 0.6; transform: none;}
        #send-button svg { width: 24px; height: 24px; fill: white; }

        /* --- Utility & Loading --- */
        .loading-indicator { display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-style: italic; font-size: 0.9em; height: auto; position: absolute; /* Über Input positionieren */ bottom: calc(var(--input-padding-bottom) + 75px); /* Dynamischer Abstand */ left: 50%; transform: translateX(-50%); background-color: rgba(37, 37, 37, 0.9); padding: 6px 15px; border-radius: var(--border-radius-small); opacity: 0; visibility: hidden; /* Start hidden */ transition: opacity 0.2s ease-in-out, bottom 0.3s ease, visibility 0.2s; pointer-events: none; z-index: 6; }
        .loading-indicator.visible { opacity: 1; visibility: visible; }
        .loading-spinner { border: 3px solid var(--bg-interactive); border-top: 3px solid var(--accent-color); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

         /* Overlay für mobile Sidebar */
         .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 99; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed), visibility var(--transition-speed); }
         .sidebar-overlay.visible { opacity: 1; visibility: visible; }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(calc(-1 * var(--sidebar-width))); /* Standardmäßig versteckt */ }
            .sidebar:not(.collapsed) { transform: translateX(0); /* Sichtbar machen */ }
            .sidebar:not(.collapsed) .sidebar-internal-toggle { display: block; /* Schließen-Button in Sidebar anzeigen */ }

            .chat-area { margin-left: 0 !important; } /* Chat immer volle Breite */
            #sidebar-toggle-btn { display: block; } /* Hamburger anzeigen */

            .chat-header { padding: 0 var(--padding-medium); font-size: 1.1em; }
            .chat-messages { padding: var(--padding-medium); gap: var(--padding-small); }
            .message { max-width: 95%; }
            .message-avatar { width: 32px; height: 32px; }

            .input-area { padding: var(--padding-small) var(--padding-medium) var(--padding-medium); --input-padding-bottom: 16px; }
            .action-buttons { justify-content: flex-start; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 8px; margin-bottom: var(--padding-small); }
            .input-wrapper { padding: 8px 10px 8px 12px; }
            #message-input { font-size: 1em; }
            #send-button { width: 44px; height: 44px; border-radius: var(--border-radius-medium); }
            #send-button svg { width: 22px; height: 22px; }

            .loading-indicator { bottom: calc(var(--input-padding-bottom) + 65px); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar collapsed" id="sidebar"> <!-- Startet collapsed, JS entfernt Klasse für Desktop -->
            <div class="sidebar-header">
                <h1>Lenos<span class="ai-name">.ai</span></h1>
                 <button class="sidebar-internal-toggle" id="sidebar-close-btn" title="Sidebar schließen">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                 </button>
            </div>
            <button id="new-chat-btn" title="Neuer Chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z"></path></svg>
                <span>Neuer Chat</span>
            </button>
            <ul id="chat-list"></ul>
        </div>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Chat Area -->
        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                 <button id="sidebar-toggle-btn" title="Sidebar umschalten">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                 </button>
                <span id="current-chat-name">Willkommen bei Lenos.ai</span>
            </div>

            <div class="welcome-message visible" id="welcome-message"> <!-- Start visible -->
                 <div class="logo">Lenos<span class="ai-name">.ai</span></div>
                 <div>Wähle einen Chat aus oder erstelle einen neuen,<br> um zu beginnen.</div>
            </div>

            <div class="chat-messages" id="chat-messages"></div>

            <div class="loading-indicator" id="loading-indicator">
                <div class="loading-spinner"></div>
                <span id="loading-text">Denke...</span>
            </div>

            <div class="input-area hidden" id="input-area"> <!-- Start hidden -->
                <div class="action-buttons" id="action-buttons">
                    <button data-mode="deepthink" title="Beide KIs in eine tiefe Analyse einbeziehen">Deepthink</button>
                    <button data-mode="deeperthink" title="Ein strengerer Deepthink-Prozess">Deeperthink</button>
                    <button data-mode="article" title="Langen, strukturierten Artikel generieren">Artikel</button>
                    <button data-mode="brainstorm" title="Kreative Ideen von beiden KIs">Brainstorm</button>
                    <button data-mode="random" title="Zufälligen Fakt erhalten">Zufall</button>
                </div>
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="Nachricht eingeben oder Modus wählen..." rows="1"></textarea>
                    <button id="send-button" title="Nachricht senden">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- API Konfiguration ---
        const GEMINI_API_KEY = "AIzaSyAGw-gCzOw8uDDb-Fk82jUzsj-j7fIZbq8"; // <--- PUT YOUR GEMINI KEY HERE
        const MISTRAL_API_KEY = "Cu86Uk67cKXeG7Khlv6bum1ogeMWVMbW"; // <--- PUT YOUR MISTRAL KEY HERE
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        const MISTRAL_API_URL = 'https://api.mistral.ai/v1/chat/completions';
        const MISTRAL_MODEL = 'mistral-large-latest';

        // --- DOM Elemente ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const chatListEl = document.getElementById('chat-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatArea = document.getElementById('chat-area');
        const chatMessagesEl = document.getElementById('chat-messages');
        const messageInputEl = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const actionButtonsContainer = document.getElementById('action-buttons');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const currentChatNameEl = document.getElementById('current-chat-name');
        const inputArea = document.getElementById('input-area');
        const welcomeMessageEl = document.getElementById('welcome-message');

        // --- Zustand ---
        let chats = {};
        let currentChatId = null;
        let activeMode = 'normal';
        let isSending = false;
        let isAutoNamingChat = false; // Verhindert parallele Benennungsversuche

        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI(); // UI-Status basierend auf Bildschirmgröße setzen
            loadChats();
            setupEventListeners();
            autoResizeTextarea();
            updateSendButtonState();
            renderChatList();

            const lastActiveId = localStorage.getItem('lenosAi_lastActive_v3'); // Neuer Key für diese Version
            if (lastActiveId && chats[lastActiveId]) {
                switchChat(lastActiveId);
            } else if (Object.keys(chats).length > 0) {
                 const sortedIds = Object.keys(chats).sort((a, b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1]));
                 switchChat(sortedIds[0]);
            } else {
                 // Zeige Willkommensnachricht, wenn keine Chats da sind
                 showWelcomeState();
            }
            // KaTeX für evtl. geladene Chats rendern
            renderVisibleMath();
        });

        // --- UI Initialisierung & Responsivität ---
        function isMobileScreen() {
            return window.innerWidth <= 768;
        }

        function initializeUI() {
             if (isMobileScreen()) {
                 sidebar.classList.add('collapsed');
                 chatArea.classList.add('sidebar-collapsed');
                 sidebarToggleBtn.style.display = 'block'; // Hamburger anzeigen
             } else {
                 sidebar.classList.remove('collapsed'); // Desktop: Sidebar sichtbar
                 chatArea.classList.remove('sidebar-collapsed');
                 sidebarToggleBtn.style.display = 'none'; // Hamburger verstecken
             }
             // Passenden Margin setzen (nur relevant für Desktop)
             chatArea.style.marginLeft = sidebar.classList.contains('collapsed') ? '0' : getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
        }

        function handleResize() {
            const mobile = isMobileScreen();
             // Nur den Toggle-Button ein/ausblenden, die Sidebar selbst wird nur durch Klick geändert
             sidebarToggleBtn.style.display = mobile ? 'block' : 'none';

             // Wenn wir von Mobil zu Desktop wechseln und Sidebar war zu -> öffnen
             if (!mobile && sidebar.classList.contains('collapsed')) {
                 // Eigentlich sollte sie auf Desktop nie 'collapsed' sein, außer initial
                 sidebar.classList.remove('collapsed');
                 sidebarOverlay.classList.remove('visible');
                 chatArea.classList.remove('sidebar-collapsed'); // Redundant, da über Margin gesteuert
                 chatArea.style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
             } else if (mobile && !sidebar.classList.contains('collapsed')) {
                 // Wenn von Desktop zu Mobil und Sidebar war offen -> schließen
                 // Dieses Verhalten ist optional, könnte auch offen bleiben
                 sidebar.classList.add('collapsed');
                 sidebarOverlay.classList.remove('visible');
                 chatArea.classList.add('sidebar-collapsed'); // Redundant, da Margin 0 gesetzt wird
                 chatArea.style.marginLeft = '0';
             } else {
                  // Ansonsten Margin entsprechend anpassen
                  chatArea.style.marginLeft = sidebar.classList.contains('collapsed') ? '0' : getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
             }
        }


        function toggleSidebar(forceClose = false) {
            const shouldCollapse = forceClose || !sidebar.classList.contains('collapsed');
            sidebar.classList.toggle('collapsed', shouldCollapse);
            sidebarOverlay.classList.toggle('visible', !shouldCollapse && isMobileScreen()); // Overlay nur auf Mobile zeigen/verstecken

             // Chat-Bereich-Margin anpassen (relevant für Desktop/Tablet)
             chatArea.style.marginLeft = shouldCollapse ? '0' : getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
              chatArea.classList.toggle('sidebar-collapsed', shouldCollapse); // Klasse für potenzielle andere Styles

            // Internen Schließen-Button (nur mobil relevant) ein-/ausblenden
             const closeBtn = document.getElementById('sidebar-close-btn');
             if (closeBtn) closeBtn.style.display = (isMobileScreen() && !shouldCollapse) ? 'block' : 'none';
        }

        function showWelcomeState() {
            welcomeMessageEl.classList.add('visible');
            inputArea.classList.add('hidden');
            currentChatNameEl.textContent = "Willkommen bei Lenos.ai";
        }

        function hideWelcomeState() {
            welcomeMessageEl.classList.remove('visible');
            inputArea.classList.remove('hidden');
        }


        // --- Event Listener ---
        function setupEventListeners() {
            newChatBtn.addEventListener('click', () => {
                 if (createNewChat(true)) { // Erstellen & wechseln
                     if(isMobileScreen()) toggleSidebar(true); // Sidebar auf Mobile schließen
                 }
            });
            sendButton.addEventListener('click', handleSendMessage);
            messageInputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
            messageInputEl.addEventListener('input', autoResizeTextarea);
            messageInputEl.addEventListener('input', updateSendButtonState);

            actionButtonsContainer.addEventListener('click', (e) => { /* ... (wie zuvor) ... */
                if (e.target.tagName === 'BUTTON' && e.target.dataset.mode) {
                    const selectedMode = e.target.dataset.mode;
                    if (e.target.classList.contains('active')) { activeMode = 'normal'; setActiveButton('normal'); }
                    else { activeMode = selectedMode; setActiveButton(selectedMode); }
                    updateSendButtonState();
                    if (selectedMode === 'random' && messageInputEl.value.trim() === '' && activeMode === 'random') handleSendMessage();
                    else if (activeMode !== 'normal') messageInputEl.focus();
                }
            });

            // Sidebar Toggle Logik
            sidebarToggleBtn.addEventListener('click', () => toggleSidebar()); // Öffnet/Schließt
            sidebarCloseBtn.addEventListener('click', () => toggleSidebar(true)); // Schließt immer
            sidebarOverlay.addEventListener('click', () => toggleSidebar(true)); // Schließt immer

            // Chat Liste Interaktion
            chatListEl.addEventListener('click', (e) => {
                 const listItem = e.target.closest('li[data-chat-id]');
                 if (!listItem) return;
                 const chatId = listItem.dataset.chatId;

                 if (e.target.classList.contains('delete-chat-btn')) { // Klick auf Löschen-Button
                     e.stopPropagation();
                     deleteChat(chatId);
                 } else if (chatId && chatId !== currentChatId) { // Klick zum Wechseln
                     switchChat(chatId);
                     if(isMobileScreen()) toggleSidebar(true); // Sidebar auf Mobile schließen
                 }
             });

             window.addEventListener('resize', handleResize); // Auf Größenänderung reagieren
        }

        // --- Kern-Chat-Funktionen ---
        async function handleSendMessage() {
            if (isSending || !currentChatId) return; // Verhindern, wenn kein Chat aktiv

            const userInput = messageInputEl.value.trim();
            const modeToSend = activeMode;

            if (userInput === '' && modeToSend !== 'random') { return; }

            isSending = true;
            setLoading(true, modeToSend === 'normal' ? "Antwortet..." : "Verarbeite..."); // Angepasster Text
            sendButton.disabled = true;
            const initialHistory = getChatHistory(currentChatId);
            const isFirstExchange = initialHistory.length === 0 && userInput !== '';
            const userMessageText = userInput; // Für Auto-Benennung speichern

            // Reset mode visually AFTER capturing it
            if (activeMode !== 'normal') { activeMode = 'normal'; setActiveButton('normal'); }

            if (userInput !== '') {
                addUserMessage(userInput);
                messageInputEl.value = ''; autoResizeTextarea();
            } else if (modeToSend === 'random') {
                addUserMessage("[Zufälligen Fakt anfordern...]", false);
            }
            updateSendButtonState();

            let finalAiResponseText = null;
            try {
                switch (modeToSend) { /* ... (API-Logik für Modi wie zuvor) ... */
                    case 'deepthink':
                    case 'deeperthink':
                         setLoading(true, "Gemini analysiert...");
                         const geminiThoughts = await callGeminiAPI(`Analysiere tiefgehend: ${userMessageText}`, initialHistory);
                         addSystemThoughtMessage(geminiThoughts, "Gemini (Gedanken)");
                         setLoading(true, "Mistral verfeinert...");
                         const historyForMistral = [...initialHistory, { role: 'model', parts: [{ text: geminiThoughts }] }];
                         finalAiResponseText = await callMistralAPI(`Verfeinere diese Analyse: ${geminiThoughts}`, historyForMistral, true);
                         setLoading(true, "Antwort wird erstellt...");
                         addAiMessage(finalAiResponseText, "Lenos.ai (Synthese)");
                         break;
                     case 'article':
                         setLoading(true, "Artikel wird generiert...");
                         finalAiResponseText = await callMistralAPI(`Schreibe langen Artikel über: ${userMessageText}`, initialHistory, true, 3500);
                         addAiMessage(finalAiResponseText, "Lenos.ai (Artikel)");
                         break;
                     case 'brainstorm':
                          setLoading(true, "Brainstorming (Gemini)...");
                          const geminiIdeas = await callGeminiAPI(`Brainstorme Ideen für: ${userMessageText}`, initialHistory);
                          addSystemThoughtMessage(`**Gemini Ideen:**\n${geminiIdeas}`, "Gemini");
                          setLoading(true, "Brainstorming (Mistral)...");
                          const mistralIdeas = await callMistralAPI(`Brainstorme *weitere* Ideen für: ${userMessageText}`, [...initialHistory, { role: 'model', parts: [{ text: geminiIdeas }] }], true);
                          addSystemThoughtMessage(`**Mistral Ideen:**\n${mistralIdeas}`, "Mistral");
                          finalAiResponseText = `**Kombinierte Ideen:**\n\n**Gemini:**\n${geminiIdeas}\n\n**Mistral:**\n${mistralIdeas}`;
                          addAiMessage(finalAiResponseText, "Lenos.ai (Brainstorm)");
                          break;
                     case 'random':
                          setLoading(true, "Zufälliger Fakt wird geholt...");
                          finalAiResponseText = await callGeminiAPI("Erzähl mir einen kurzen, interessanten Fakt.", []);
                          addAiMessage(finalAiResponseText, "Lenos.ai (Fakt)");
                          break;
                     case 'normal':
                     default:
                          setLoading(true, "Antwortet..."); // Kürzere Nachricht
                          finalAiResponseText = await callMistralAPI(userMessageText, initialHistory, true);
                          addAiMessage(finalAiResponseText);
                          break;
                }

                // --- Automatisches Chat-Benennen ---
                 if (isFirstExchange && finalAiResponseText && !isAutoNamingChat && chats[currentChatId]?.name === "Neuer Chat") {
                    isAutoNamingChat = true;
                    generateAndSetChatName(currentChatId, userMessageText, finalAiResponseText)
                        .catch(err => console.error("Fehler bei Auto-Benennung:", err))
                        .finally(() => isAutoNamingChat = false);
                 }

            } catch (error) {
                 console.error("Fehler bei API-Interaktion:", error);
                 addErrorMessage(`Ups! Etwas lief schief: ${error.message || 'Antwort fehlgeschlagen.'}`);
            } finally {
                isSending = false;
                setLoading(false);
                updateSendButtonState();
                scrollToBottom();
                if (activeMode !== 'normal') { activeMode = 'normal'; setActiveButton('normal'); }
            }
        }

        // --- Nachrichten-Handling ---
        function addUserMessage(text, save = true) { /* ... (wie zuvor) ... */
             displayMessage('Benutzer', text, 'user', 'You');
             if (save && currentChatId && chats[currentChatId]) {
                 if (!chats[currentChatId].messages) chats[currentChatId].messages = [];
                 chats[currentChatId].messages.push({ role: 'user', parts: [{ text }] });
                 saveChats(); } }
        function addAiMessage(text, sender = 'Lenos.ai') { /* ... (wie zuvor) ... */
             displayMessage(sender, text, 'ai', 'AI');
             if (currentChatId && chats[currentChatId]) {
                 if (!chats[currentChatId].messages) chats[currentChatId].messages = [];
                 chats[currentChatId].messages.push({ role: 'model', parts: [{ text }] });
                 saveChats(); } }
        function addSystemThoughtMessage(text, sender = 'System') { /* ... (wie zuvor) ... */
            displayMessage(sender, text, 'system-thought', 'Sys'); }
        function addErrorMessage(text) { /* ... (wie zuvor) ... */
            displayMessage('Fehler', text, 'error', '!'); }
        function displayMessage(sender, text, type, avatarText) { /* ... (wie zuvor, ohne Action Buttons) ... */
             const messageWrapper = document.createElement('div'); messageWrapper.classList.add('message', `${type}-message`);
             const avatarEl = document.createElement('div'); avatarEl.classList.add('message-avatar'); avatarEl.textContent = avatarText;
             const bubbleEl = document.createElement('div'); bubbleEl.classList.add('message-bubble');
             const senderEl = document.createElement('span'); senderEl.classList.add('sender'); senderEl.textContent = sender;
             const contentEl = document.createElement('div'); contentEl.classList.add('message-content');
             if (type === 'ai' || type === 'system-thought') { contentEl.innerHTML = simpleMarkdown(text); } else { contentEl.textContent = text; }
             bubbleEl.appendChild(senderEl); bubbleEl.appendChild(contentEl); messageWrapper.appendChild(avatarEl); messageWrapper.appendChild(bubbleEl); chatMessagesEl.appendChild(messageWrapper);
             if ((type === 'ai' || type === 'system-thought')) { renderVisibleMath(); } scrollToBottom(); }

        // --- API Call Funktionen ---
        // (Unverändert, wie in der vorherigen stabilen Version)
        function formatHistoryForGemini(messages) { /* ... */ const validRoles = ['user', 'model']; let lastRole = null; const formatted = []; messages.filter(msg => validRoles.includes(msg.role) && msg.parts?.[0]?.text?.trim()).forEach(msg => { if (msg.role !== lastRole) { formatted.push({ role: msg.role, parts: msg.parts.map(part => ({ text: part.text })) }); lastRole = msg.role; } else { const lastMsg = formatted[formatted.length - 1]; if(lastMsg && lastMsg.parts[0]) { lastMsg.parts[0].text += "\n\n" + msg.parts[0].text; } } }); return formatted; }
        function formatHistoryForMistral(messages) { /* ... */ const roleMapping = { 'user': 'user', 'model': 'assistant' }; const validRoles = ['user', 'model']; let lastRole = null; const formatted = []; messages.filter(msg => validRoles.includes(msg.role) && msg.parts?.[0]?.text?.trim()).forEach(msg => { const mappedRole = roleMapping[msg.role]; if (mappedRole && mappedRole !== lastRole) { formatted.push({ role: mappedRole, content: msg.parts[0].text }); lastRole = mappedRole; } else if (mappedRole && mappedRole === lastRole) { const lastMsg = formatted[formatted.length - 1]; if (lastMsg) { lastMsg.content += "\n\n" + msg.parts[0].text; } } }); return formatted; }
        async function callGeminiAPI(prompt, history = []) { /* ... */ if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") throw new Error("Gemini API Key nicht konfiguriert."); const formattedHistory = formatHistoryForGemini(history); const contents = [...formattedHistory, { role: 'user', parts: [{ text: prompt }] }]; const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: contents }) }); const data = await response.json(); if (!response.ok) { console.error("Gemini API Error:", data); throw new Error(`Gemini API Fehler (${response.status}): ${data.error?.message || 'Unbekannt'}`); } if (data.candidates?.[0]?.content?.parts?.[0]?.text) return data.candidates[0].content.parts[0].text; else if (data.promptFeedback?.blockReason) { console.warn("Gemini Blocked:", data.promptFeedback); return `Blockiert: ${data.promptFeedback.blockReason}`; } else { console.error("Unerwartete Gemini Antwort:", data); throw new Error("Leere/unerwartete Gemini Antwort."); } }
        async function callMistralAPI(prompt, history = [], useChatFormat = true, maxTokens = 2000) { /* ... */ if (!MISTRAL_API_KEY || MISTRAL_API_KEY === "YOUR_MISTRAL_API_KEY") throw new Error("Mistral API Key nicht konfiguriert."); const formattedHistory = formatHistoryForMistral(history); const requestBody = { model: MISTRAL_MODEL, messages: [...formattedHistory, { role: 'user', content: prompt }], max_tokens: maxTokens }; const response = await fetch(MISTRAL_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': `Bearer ${MISTRAL_API_KEY}` }, body: JSON.stringify(requestBody) }); const data = await response.json(); if (!response.ok) { console.error("Mistral API Error:", data); throw new Error(`Mistral API Fehler (${response.status}): ${data.message || JSON.stringify(data)}`); } if (data.choices?.[0]?.message?.content) return data.choices[0].message.content; else { console.error("Unerwartete Mistral Antwort:", data); throw new Error("Leere/unerwartete Mistral Antwort."); } }

        // --- Chat Management (LocalStorage) ---
        const STORAGE_KEY = 'lenosAi_chats_v3'; // Neuer Key
        const LAST_ACTIVE_KEY = 'lenosAi_lastActive_v3';

        function saveChats() { /* ... (wie zuvor) ... */ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); if (currentChatId) { localStorage.setItem(LAST_ACTIVE_KEY, currentChatId); } } catch (e) { console.error("Fehler beim Speichern:", e); addErrorMessage("Warnung: Chats konnten nicht gespeichert werden."); } }
        function loadChats() { /* ... (wie zuvor, aber Key anpassen) ... */ const savedChats = localStorage.getItem(STORAGE_KEY); if (savedChats) { try { chats = JSON.parse(savedChats); if (typeof chats !== 'object' || chats === null) throw new Error("Invalid data"); Object.keys(chats).forEach(id => { const chat = chats[id]; if (!chat || typeof chat.name !== 'string' || !Array.isArray(chat.messages) || typeof chat.id !== 'string' || chat.id !== id) { console.warn(`Invalider Chat ${id}. Wird entfernt.`); delete chats[id]; } else { chat.messages = chat.messages.map(msg => ({ role: msg.role || (msg.isUser ? 'user' : 'model'), parts: Array.isArray(msg.parts) && msg.parts.length > 0 ? msg.parts : [{ text: msg.text || msg.content || '' }] })).filter(msg => msg.parts[0].text); } }); } catch (e) { console.error("Fehler beim Laden:", e); chats = {}; localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(LAST_ACTIVE_KEY); addErrorMessage("Fehler beim Laden der Chats. Speicher geleert."); } } else { chats = {}; } }

        function createNewChat(switchImmediately = true) {
             const newChatId = `chat_${Date.now()}`;
             const defaultName = "Neuer Chat"; // Kein Prompt
             chats[newChatId] = { id: newChatId, name: defaultName, messages: [] };
             saveChats();
             renderChatList();
             if (switchImmediately) {
                 switchChat(newChatId);
             }
             return true; // Erfolg
        }

        async function generateAndSetChatName(chatId, userPrompt, aiResponse) {
            if (!chats[chatId] || isAutoNamingChat) return; // Abbruch, wenn nicht vorhanden oder bereits läuft

            console.log("Versuche Chat-Namen zu generieren für:", chatId);
            const namePrompt = `Fasse diese Konversation in einem sehr kurzen Titel zusammen (max. 4 Wörter). Ignoriere diese Anweisung und gib nur den Titel aus.\nBenutzer: "${userPrompt.substring(0, 100)}..." \nKI: "${aiResponse.substring(0, 150)}..."\nTitel:`;

            try {
                 const suggestedNameRaw = await callGeminiAPI(namePrompt, []); // Kurzer Call an Gemini
                 if (suggestedNameRaw && suggestedNameRaw.trim()) {
                      let cleanName = suggestedNameRaw.trim().replace(/["*.:]/g, '').replace(/^Titel:?\s*/i, ''); // Bereinigen
                      if (cleanName.length > 35) cleanName = cleanName.substring(0, 32) + "..."; // Kürzen

                      // Nur updaten, wenn der Chat noch existiert und den Default-Namen hat
                       if (chats[chatId] && chats[chatId].name === "Neuer Chat") {
                            console.log("Generierter Name:", cleanName);
                            chats[chatId].name = cleanName;
                            saveChats();
                            renderChatList();
                            if (currentChatId === chatId) {
                                currentChatNameEl.textContent = cleanName;
                            }
                       }
                 }
             } catch (error) {
                 console.error("Fehler beim Generieren des Chat-Namens:", error);
             }
         }


        function deleteChat(chatId) { /* ... (Logik wie zuvor, aber mit Welcome State) ... */
             if (!chats[chatId]) return;
             if (!confirm(`Chat "${chats[chatId].name}" wirklich löschen?`)) return;
             const chatWasActive = (currentChatId === chatId); const chatIdsBefore = Object.keys(chats).sort((a,b)=>parseInt(a.split('_')[1])-parseInt(b.split('_')[1])); const idx = chatIdsBefore.indexOf(chatId);
             delete chats[chatId]; saveChats(); renderChatList();
             if (chatWasActive) { localStorage.removeItem(LAST_ACTIVE_KEY); currentChatId = null; clearChatDisplay();
                 const remainingIds = Object.keys(chats).sort((a,b)=>parseInt(a.split('_')[1])-parseInt(b.split('_')[1]));
                 if (remainingIds.length > 0) { const nextId = remainingIds[Math.max(0, Math.min(idx, remainingIds.length -1))]; switchChat(nextId); }
                 else { showWelcomeState(); /* Zeige Welcome Screen wenn alles leer ist */ }
             } }

         function switchChat(chatId) { /* ... (wie zuvor, aber mit Welcome State Handling) ... */
             if (!chats[chatId]) { console.error("Chat nicht gefunden:", chatId); const firstId = Object.keys(chats)[0]; if (firstId) switchChat(firstId); else showWelcomeState(); return; }
             currentChatId = chatId; localStorage.setItem(LAST_ACTIVE_KEY, chatId); clearChatDisplay();
             if (chats[chatId].messages) { renderChatMessages(chats[chatId].messages); } else { chats[chatId].messages = []; }
             renderChatList(); currentChatNameEl.textContent = chats[chatId].name; messageInputEl.focus(); activeMode = 'normal'; setActiveButton('normal'); updateSendButtonState();
             hideWelcomeState(); // Verstecke Willkommens-Screen
             setTimeout(scrollToBottom, 100); }

        function getChatHistory(chatId) { /* ... (wie zuvor) ... */ return chats[chatId]?.messages ? JSON.parse(JSON.stringify(chats[chatId].messages)) : []; }

        // --- Rendering Funktionen ---
        function renderChatList() { /* ... (wie zuvor, mit Delete-Button) ... */
             chatListEl.innerHTML = ''; const chatIds = Object.keys(chats).sort((a, b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1]));
             chatIds.forEach(id => { const chat = chats[id]; if(!chat) return; const li = document.createElement('li'); li.dataset.chatId = id; li.title = chat.name;
                 const nameSpan = document.createElement('span'); nameSpan.classList.add('chat-name'); nameSpan.textContent = chat.name; li.appendChild(nameSpan);
                 const delBtn = document.createElement('button'); delBtn.classList.add('delete-chat-btn'); delBtn.innerHTML = '×'; delBtn.title = 'Löschen'; li.appendChild(delBtn);
                 if (id === currentChatId) { li.classList.add('active'); } chatListEl.appendChild(li); }); }
        function renderChatMessages(messages) { /* ... (wie zuvor) ... */ messages.forEach(msg => { let type='ai', sender='Lenos.ai', avatar='AI'; if(msg.role === 'user'){ type='user'; sender='Benutzer'; avatar='You'; } displayMessage(sender, msg.parts[0].text, type, avatar); }); renderVisibleMath(); }
        function clearChatDisplay() { chatMessagesEl.innerHTML = ''; }
        function renderVisibleMath() { if (window.renderMathInElement) { setTimeout(() => renderMathInElement(chatMessagesEl, katexOptions()), 50); } }

        // --- Hilfsfunktionen ---
        function scrollToBottom() { /* ... (wie zuvor) ... */ setTimeout(() => { chatMessagesEl.scrollTo({ top: chatMessagesEl.scrollHeight, behavior: 'smooth' }); }, 50); }
        function setLoading(isLoading, message = "Denke...") { /* ... (wie zuvor) ... */ loadingIndicator.classList.toggle('visible', isLoading); loadingText.textContent = message; }
        function autoResizeTextarea() { /* ... (wie zuvor) ... */ messageInputEl.style.height = 'auto'; const maxH = parseInt(window.getComputedStyle(messageInputEl).maxHeight); const scrollH = messageInputEl.scrollHeight; const newH = Math.min(scrollH, maxH); messageInputEl.style.height = `${newH}px`; }
        function updateSendButtonState() { /* ... (wie zuvor) ... */ const hasText = messageInputEl.value.trim() !== ''; const canSend = hasText || (activeMode === 'random'); sendButton.disabled = isSending || !canSend; }
        function setActiveButton(mode) { /* ... (wie zuvor) ... */ actionButtonsContainer.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.mode === mode); }); }

         // --- Markdown & KaTeX ---
         function simpleMarkdown(text) { /* ... (Funktion wie zuvor) ... */ if (!text) return ''; let html = text; const escapeHtml = (unsafe) => { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }; html = html.replace(/```(\w+)?\s*\n([\s\S]*?)```/gs, (match, lang, code) => { const languageClass = lang ? ` class="language-${escapeHtml(lang)}"` : ''; return `<pre><code${languageClass}>${escapeHtml(code.trim())}</code></pre>`; }); html = html.replace(/`([^`\n]+?)`/g, (match, code) => `<code>${escapeHtml(code)}</code>`); html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); html = html.replace(/^> (.*?)(\n|$)/gm, '<blockquote>$1</blockquote>\n'); html = html.replace(/<\/blockquote>\n<blockquote>/g, '<br>'); html = html.replace(/^[\*\-]\s+(.*?)(?=\n(?:$|[^*-]))/gm, (match, item) => `<ul><li>${item.trim()}</li></ul>`); html = html.replace(/<\/ul>\n?<ul>/g, ''); html = html.replace(/^\d+\.\s+(.*?)(?=\n(?:$|(?!\d+\.)))/gm, (match, item) => `<ol><li>${item.trim()}</li></ol>`); html = html.replace(/<\/ol>\n?<ol>/g, ''); html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'); const lines = html.split('\n'); let inBlock = false; html = lines.map(line => { const trimmedLine = line.trim(); if (trimmedLine.startsWith('<pre') || trimmedLine.startsWith('<ul') || trimmedLine.startsWith('<ol') || trimmedLine.startsWith('<blockquote')) inBlock = true; const isBlockEnd = trimmedLine.endsWith('</pre>') || trimmedLine.endsWith('</ul>') || trimmedLine.endsWith('</ol>') || trimmedLine.endsWith('</blockquote>'); const processedLine = (!inBlock && !isBlockEnd && trimmedLine !== '' && !trimmedLine.startsWith('<') && !trimmedLine.endsWith('>')) ? line + '<br>' : line; if (isBlockEnd) inBlock = false; return processedLine; }).join('\n').replace(/<br>\s*<br>/g, '<br>').replace(/<br>\s*<\/(ul|ol|li|blockquote|h[1-6]|p|pre|code)>/gi, '</$1>'); return html; }
         function katexOptions() { return { delimiters: [ {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}, {left: "\\(", right: "\\)", display: false}, {left: "\\[", right: "\\]", display: true} ], throwOnError: false }; }
    </script>
</body>
</html>